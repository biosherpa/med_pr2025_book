---
title: "Práctica 11. Comparación de proporciones (II)" 
author: "Mi nombre"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---


## 1.1. Preparando la base de datos

Seleccionar directorio de trabajo y a obtener la dase de datos de trabajo, en este caso df_iam3, 

```{r}
#setwd()
getwd ()

df_iam3<-read.csv ("df_iam3.csv")
```

En esta base se recogen una serie de características de 984 sujetos. De todos se incluyeron características sociodemográficas ( `fech_nac`, `sex` y `clas_soc` ), clínicas (`hta` , `DM`, `colesterol` , `salud` ) y el hábito tabáquico (`fum`). En un momento en el tiempo se recogió qué sujetos habían tenido un evento tipo infarto de miocardio `iam`). Posteriormente se siguió a los sujetos hasta otro punto en el tiempo. Tras ese punto t, sólo se recogió si el sujeto seguía fumando tras el primer infarto (`fum_p`) , la cifra de colesterol (`colesterol_p`), la percepción de salud posterior al infarto (`salud_p` ) y la ocurrencia de un nuevo reinfarto (`iam2`).

Vamos a obtener la variable edad (en años cumplidos), suponiendo que la fecha final de seguimiento es el 31/12/2023 a partir de la variable `fech_nac`

```{r}
#fech_nac viene definida como character, cambiamos a formato fecha
df_iam3$fech_nac <- as.Date(df_iam3$fech_nac)
fecha_fin <- as.Date("2023-12-31")
df_iam3$edad <- (fecha_fin-df_iam3$fech_nac)/365.25
df_iam3$edad <- as.numeric (round (df_iam3$edad,0))


```

Seguidamente vamos a convertir en factor las variables `sex` (etiquetas: 0="mujer; 1= "Varón"), `hta` , `DM` , `fum` , `fum_p` , `iam1` e `iam2` , con las etiquetas (0="No", 1="Sí") y la variable `clas_soc` con las etiquetas (0= "baja"; 1=" Media", 2= Alta"), y `salud` y `salud_p` con las etiquetas (0="Muy mala"; 1="Mala"; 2= "Regular"; 3= "Buena"; 4= "Muy buena")

```{r}
df_iam3$sex <- factor(df_iam3$sex, levels = c(0, 1), 
                      labels = c("Mujer", "Varón"))
df_iam3$hta <- factor(df_iam3$hta, levels = c(0, 1), labels = c("No", "Sí"))
df_iam3$DM <- factor(df_iam3$DM, levels = c(0, 1), labels = c("No", "Sí"))
df_iam3$fum <- factor(df_iam3$fum, levels = c(0, 1), labels = c("No", "Sí"))
df_iam3$fum_p <- factor(df_iam3$fum_p, 
                        levels = c(0, 1), labels = c("No", "Sí"))
df_iam3$salud <- factor(df_iam3$salud, 
                        levels = c(0,1, 2,3,4), 
                        labels = c("Muy mala", "Mala",
                                   "Regular", "Buena", "Muy buena"))
df_iam3$salud_p <- factor(df_iam3$salud_p, 
                        levels = c(0,1, 2,3,4), 
                        labels = c("Muy mala", "Mala",
                                   "Regular", "Buena", "Muy buena"))
df_iam3$iam1 <- factor(df_iam3$iam1, levels = c(0, 1), labels = c("No", "Sí"))
df_iam3$iam2 <- factor(df_iam3$iam2, levels = c(0, 1), labels = c("No", "Sí"))
df_iam3$clas_soc <- factor(df_iam3$clas_soc, 
                           levels = c(0, 1, 2), 
                           labels = c("Baja", "Media", "Alta"))
```

Comprueba que ha funcionado todo bien

```{r}
head (df_iam3)
```

## 2. Comparación de proporciones, tablas de n x m

### 2.1 Datos independientes

Vamos a ver si las proporciones de hipertensos son diferentes en las diferentes categorías de la variable `clas_soc`

```{r}
# Crear la tabla de contingencia
tabla_htaclass <- table(df_iam3$hta, df_iam3$clas_soc)


tabla_htaclass

# Realizar la prueba Chi-Cuadrado
chi_test <- chisq.test(tabla_htaclass)

# Mostrar resultados de la prueba
print(chi_test)

# Frecuencias esperadas
cat("Frecuencias esperadas:\n")
print(chi_test$expected)
```

No hay diferencias en las proporciones de HT por clase social y no hay ninguna frecuencia esperada menos que 5, podríamos hacer el test de Chi cuadrado sin la corrección de Yates

```{r}
chi_test <- chisq.test(tabla_htaclass, correct = FALSE)
chi_test
```

El resultado da exactamente igual, con la n grande la corrección de Yates apenas tiene impacto.

### 3.2 Datos apareados

Vamos a utilizar los datos de percepción del estado de salud antes y después del primer infarto para ver si hay diferencias (`salud` y `salud_p` )

Se tratan de datos apareados con 5 niveles en cada variable (ordenados)

Utilizaremos la prueba de Friedman

```{r}

tabla_friedman <- table(df_iam3$salud, df_iam3$salud_p)
tabla_friedman
#Friendman necesita un formato largo

# Crear una matriz de salud antes y después
matriz_salud <- as.matrix(cbind(df_iam3$salud, df_iam3$salud_p))

# Aplicar la Prueba de Friedman
friedman_result <- friedman.test(matriz_salud)
friedman_result

```

Hay diferencias entre los grupos no achacables al azar.

## 4. Test de tendencia lineal

Podríamos preguntarnos si hay menos proporción de fumadores a medida que aumenta el nivel social. Vamos a intentar resolver esta cuestión con un test de tendencia lineal.

Primero generamos la tabla

```{r}

tabla_contingencia <- table(df_iam3$fum, df_iam3$clas_soc)

# Mostrar la tabla de contingencia
print(tabla_contingencia)

# Calcular las proporciones de la tabla de contingencia
proporciones <- prop.table(tabla_contingencia, margin = 2)  
proporciones
```

Y ahora hay que disponer los datos para poder usar la función `prop.trend.test`

```{r}
# Definir el número de fumadores (x)) y el tamaño de cada grupo (n)
x <- c(103, 124, 15)  
n <- c(307 + 103, 356 + 124, 79 + 15) 

# Realizar el test de tendencia
tendencia_resultado <- prop.trend.test(x, n, score = seq_along(x))


print(tendencia_resultado)

```

Aunque parece haber cierta tendencia decreciente, no se puede rechazar la hipótesis nula , que no reconoce ninguna tendencia lineal.
